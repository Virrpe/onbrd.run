import{b as t}from"./assets/logger-mdW3G7Ld.js";chrome.runtime.onInstalled.addListener(()=>{t.ok("OnboardingAudit.ai extension installed")});chrome.runtime.onMessage.addListener((r,e,i)=>(t.start(`Background script received message: ${JSON.stringify(r)}`),r.type==="RUN_AUDIT"?(a(i),!0):!1));async function a(r){try{t.start("Starting deterministic handshake...");const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.id)throw new Error("No active tab found");if(t.ok(`Active tab found: ${e.id}, ${e.url}`),await o(e.id),!await c(e.id))throw new Error("Content script not responding to PING after retry");const n=await u(e.id);t.ok(`Audit completed successfully: ${JSON.stringify(n)}`),r({success:!0,data:n})}catch(e){t.error(`Deterministic handshake failed: ${e instanceof Error?e.message:String(e)}`),r({success:!1,error:e instanceof Error?e.message:"Audit failed"})}}async function o(r){try{await chrome.scripting.executeScript({target:{tabId:r},files:["assets/content.js"]}),t.ok("Content script injected successfully")}catch(e){throw new Error(`Failed to inject content script: ${e instanceof Error?e.message:String(e)}`)}}async function c(r){if(await s(r))return!0;t.error("First PING attempt failed, retrying...");try{await o(r)}catch(n){return t.error(`Failed to re-inject content script: ${n instanceof Error?n.message:String(n)}`),!1}return await s(r)}async function s(r){try{const e=await Promise.race([chrome.tabs.sendMessage(r,{type:"PING"}),new Promise((i,n)=>setTimeout(()=>n(new Error("PING timeout")),1e3))]);return e&&typeof e=="object"&&"ok"in e&&e.ok===!0?(t.ok("PING successful - content script is responsive"),!0):(t.error(`PING response invalid: ${JSON.stringify(e)}`),!1)}catch(e){return e instanceof Error&&e.message==="PING timeout"?t.error("PING timeout - content script not responding within 1000ms"):t.error(`PING failed: ${e instanceof Error?e.message:String(e)}`),!1}}async function u(r){try{const e=await Promise.race([chrome.tabs.sendMessage(r,{type:"RUN_AUDIT"}),new Promise((i,n)=>setTimeout(()=>n(new Error("RUN_AUDIT timeout")),3e3))]);if(e&&typeof e=="object"&&"ok"in e&&e.ok===!0&&"data"in e)return t.ok("RUN_AUDIT successful - audit data received"),e.data;throw e&&typeof e=="object"&&"error"in e?new Error(`Content script error: ${e.error}`):new Error(`Invalid RUN_AUDIT response: ${JSON.stringify(e)}`)}catch(e){throw e instanceof Error&&e.message==="RUN_AUDIT timeout"?new Error("RUN_AUDIT timeout - content script not responding within 3000ms"):e}}
