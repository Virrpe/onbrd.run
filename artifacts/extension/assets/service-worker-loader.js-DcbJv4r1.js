const i="";const u=[1,5,15,30,60,120];async function l(t){await chrome.storage.session.set({onbrd_benchmark:t})}async function h(t){const{onbrd_queue:o=[]}=await chrome.storage.local.get("onbrd_queue");o.push({body:t,tries:0,nextAt:Date.now()}),await chrome.storage.local.set({onbrd_queue:o})}async function c(){const{onbrd_queue:t=[]}=await chrome.storage.local.get("onbrd_queue"),o=Date.now(),n=[];for(const e of t){if(e.nextAt>o){n.push(e);continue}try{const r=await fetch(`${self.API_BASE_URL||i}/api/v1/ingest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e.body)});if(r.ok){const a=await r.json();await l(a);continue}throw new Error("http "+r.status)}catch{e.tries++;const r=Math.min(e.tries-1,5),a=u[r];e.nextAt=Date.now()+a*60*1e3,e.tries<5&&n.push(e)}}await chrome.storage.local.set({onbrd_queue:n})}self.addEventListener("online",()=>{c()});setInterval(c,6e4);chrome.runtime.onMessage.addListener((t,o,n)=>(t==null?void 0:t.type)==="ONBRD_ENQUEUE_INGEST"?(h(t.body).then(()=>{n({success:!0})}).catch(e=>{n({success:!1,error:e.message})}),!0):(t==null?void 0:t.type)==="ONBRD_FLUSH_QUEUE"?(c().then(()=>{n({success:!0})}).catch(e=>{n({success:!1,error:e.message})}),!0):!1);async function s(){const t=new AbortController,o=setTimeout(()=>t.abort(),300);try{const n=`${self.API_BASE_URL||i}/api/v1/config`,e=await fetch(n,{signal:t.signal});if(clearTimeout(o),e.ok){const r=await e.json();await chrome.storage.session.set({onbrd_cfg:r})}}catch{}}chrome.runtime.onStartup.addListener(()=>{c(),s()});chrome.runtime.onInstalled.addListener(()=>{c(),s()});setInterval(s,6e4);
