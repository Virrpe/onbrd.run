const a={h_cta_above_fold:.25,h_steps_count:.2,h_copy_clarity:.2,h_trust_markers:.2,h_perceived_signup_speed:.15},l={h_cta_above_fold:"Move your primary CTA above the fold for immediate visibility",h_steps_count:"Reduce onboarding to 3 steps or fewer when possible",h_copy_clarity:"Use shorter sentences, active voice, and plain language",h_trust_markers:"Add testimonials, security badges, or customer logos",h_perceived_signup_speed:"Minimize required fields and show progress indicators"};function v(){const e=b(),t=q(e),o=C(e);return{id:j(),url:window.location.href,timestamp:new Date().toISOString(),heuristics:e,scores:t,recommendations:o}}function b(){return{h_cta_above_fold:S(),h_steps_count:A(),h_copy_clarity:k(),h_trust_markers:x(),h_perceived_signup_speed:M()}}function S(){const t=document.querySelectorAll('button, a, input[type="submit"], [class*="cta"], [class*="action"]');let o=!1,n=0,s="";const r=["start","begin","sign up","signup","get started","join","create","continue","next"];for(const i of t){const d=i.getBoundingClientRect(),_=(i.textContent||"").toLowerCase().trim(),u=r.some(h=>_.includes(h));if(d.top<600&&(u||i.className.toLowerCase().includes("cta"))){o=!0,n=Math.round(d.top),s=i.tagName.toLowerCase(),i.className&&(s+=`.${i.className.split(" ")[0]}`);break}}return{detected:o,position:n,element:s}}function A(){const e=document.querySelectorAll("form").length,t=document.querySelectorAll('[class*="step"], [class*="screen"], [class*="onboarding"], [class*="wizard"]').length,o=document.querySelectorAll('[class*="modal"], [role="dialog"]').length;return{total:Math.max(e,t,o,1),forms:e,screens:t}}function k(){const e=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, li, span, div");let t=0,o=0,n=0,s=0;const r=["utilize","leverage","synergy","paradigm","ecosystem","platform","solution","optimize","streamline","facilitate"];e.forEach(u=>{const g=(u.textContent||"").split(/[.!?]+/).filter(c=>c.trim().length>0);t+=g.length,g.forEach(c=>{const y=c.trim().split(/\s+/).length;o+=y,/\b(was|were|been|being|is|are|am)\s+\w+ed\b/i.test(c)&&n++;const f=c.toLowerCase();r.forEach(w=>{f.includes(w)&&s++})})});const i=t>0?Math.round(o/t):0,d=t>0?Math.round(n/t*100):0,_=o>0?Math.round(s/o*100):0;return{avg_sentence_length:i,passive_voice_ratio:d,jargon_density:_}}function x(){const e=document.querySelectorAll('[class*="testimonial"], [class*="review"], [class*="quote"], blockquote').length,t=document.querySelectorAll('[class*="security"], [class*="trust"], [class*="badge"], [class*="certified"], [alt*="security"], [alt*="ssl"]').length,o=document.querySelectorAll('[class*="logo"], [class*="customer"], [class*="client"], [alt*="logo"], img[src*="logo"]').length;return{testimonials:e,security_badges:t,customer_logos:o,total:e+t+o}}function M(){const e=document.querySelectorAll("input, select, textarea").length,t=document.querySelectorAll("[required]").length,o=document.querySelectorAll('[class*="progress"], [class*="step-indicator"]').length;let n=Math.max(e*5,t*10,30);return o>0&&(n=Math.round(n*.8)),{form_fields:e,required_fields:t,estimated_seconds:n}}function q(e){const t=e.h_cta_above_fold.detected?100:0;let o=100;e.h_steps_count.total>=8?o=40:e.h_steps_count.total>=6?o=60:e.h_steps_count.total>=4&&(o=80);let n=100;e.h_copy_clarity.avg_sentence_length>15&&(n-=Math.min(50,(e.h_copy_clarity.avg_sentence_length-15)*2)),e.h_copy_clarity.passive_voice_ratio>10&&(n-=Math.min(30,(e.h_copy_clarity.passive_voice_ratio-10)*3)),e.h_copy_clarity.jargon_density>5&&(n-=Math.min(20,(e.h_copy_clarity.jargon_density-5)*4)),n=Math.max(0,n);let s=40;e.h_trust_markers.total>=3?s=100:e.h_trust_markers.total===2?s=80:e.h_trust_markers.total===1&&(s=60);let r=40;e.h_perceived_signup_speed.estimated_seconds<30?r=100:e.h_perceived_signup_speed.estimated_seconds<60?r=80:e.h_perceived_signup_speed.estimated_seconds<120&&(r=60);const i=Math.round(t*a.h_cta_above_fold+o*a.h_steps_count+n*a.h_copy_clarity+s*a.h_trust_markers+r*a.h_perceived_signup_speed);return{h_cta_above_fold:t,h_steps_count:o,h_copy_clarity:n,h_trust_markers:s,h_perceived_signup_speed:r,overall:i}}function C(e){const t=[];return e.h_cta_above_fold.detected||t.push({heuristic:"h_cta_above_fold",priority:"high",description:"No clear call-to-action found above the fold (top 600px)",fix:l.h_cta_above_fold}),e.h_steps_count.total>3&&t.push({heuristic:"h_steps_count",priority:"medium",description:`Onboarding flow has ${e.h_steps_count.total} steps, which may cause friction`,fix:l.h_steps_count}),e.h_copy_clarity.avg_sentence_length>15&&t.push({heuristic:"h_copy_clarity",priority:"medium",description:`Average sentence length is ${e.h_copy_clarity.avg_sentence_length} words, which may reduce comprehension`,fix:l.h_copy_clarity}),e.h_copy_clarity.passive_voice_ratio>10&&t.push({heuristic:"h_copy_clarity",priority:"low",description:`${e.h_copy_clarity.passive_voice_ratio}% of sentences use passive voice, which can reduce clarity`,fix:"Use active voice to make sentences more direct and engaging"}),e.h_copy_clarity.jargon_density>5&&t.push({heuristic:"h_copy_clarity",priority:"low",description:`${e.h_copy_clarity.jargon_density}% of words are jargon, which may confuse users`,fix:"Replace technical terms with plain language"}),e.h_trust_markers.total<3&&t.push({heuristic:"h_trust_markers",priority:"medium",description:`Only ${e.h_trust_markers.total} trust signals detected, which may reduce user confidence`,fix:l.h_trust_markers}),e.h_perceived_signup_speed.estimated_seconds>60&&t.push({heuristic:"h_perceived_signup_speed",priority:"high",description:`Signup process appears to take ${e.h_perceived_signup_speed.estimated_seconds} seconds, which may cause abandonment`,fix:l.h_perceived_signup_speed}),t}function j(){return`audit-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}let p=null;const I=new MutationObserver(()=>{p&&clearTimeout(p),p=window.setTimeout(()=>{console.log("SPA content change detected, ready for re-audit")},1e3)});function m(){I.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]}),console.log("OnboardingAudit.ai MutationObserver started for SPA support")}async function T(e=1500){return new Promise(t=>{let o,n=0;const s=window.fetch;window.fetch=async(...r)=>{n++,clearTimeout(o);try{const i=await s(...r);return n--,n===0&&(o=window.setTimeout(t,500)),i}catch(i){throw n--,n===0&&(o=window.setTimeout(t,500)),i}},o=window.setTimeout(()=>{window.fetch=s,t()},e)})}async function L(e){try{console.log("Starting audit with network idle detection..."),await T(1500),console.log("Network idle detected or timeout reached, proceeding with audit");const o={...v(),metadata:{user_agent:navigator.userAgent,viewport:`${window.innerWidth}x${window.innerHeight}`,extension_version:"1.0.0",network_idle:!0,spa_support:!0}};e({success:!0,data:o})}catch(t){console.error("Audit failed:",t),e({success:!1,error:t instanceof Error?t.message:"Unknown error"})}}window.__onboardingAuditInjected?console.log("OnboardingAudit.ai content script already injected, skipping"):(window.__onboardingAuditInjected=!0,chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action==="RUN_AUDIT")return L(o),!0}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("OnboardingAudit.ai content script loaded via programmatic injection"),m()}):(console.log("OnboardingAudit.ai content script loaded via programmatic injection"),m()),document.addEventListener("visibilitychange",()=>{document.hidden||console.log("Page became visible, ready for audit")}));
