name: CI
on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

jobs:
  build-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Show versions
        run: |
          node -v
          pnpm -v || true

      - name: Install deps (root)
        run: pnpm install --frozen-lockfile

      - name: Build extension
        run: |
          pnpm --filter @onboarding-audit/extension run build || pnpm -C extension run build

      - name: Verify invariants
        run: pnpm -w run verify

      - name: Verify fonts are real WOFF2
        shell: bash
        run: |
          set -euo pipefail
          FAIL=0
          check() {
            local p="$1"
            if [[ ! -f "$p" ]]; then echo "missing: $p"; FAIL=1; return; fi
            head=$(xxd -l 4 -p "$p")
            mime=$(file --mime-type -b "$p")
            if [[ "$head" != "774f4632" ]]; then echo "bad magic (want wOF2): $p ($head)"; FAIL=1; fi
            if [[ "$mime" != "font/woff2" ]]; then echo "bad mime ($mime): $p"; FAIL=1; fi
            if grep -aq "<html" "$p"; then echo "html detected in $p"; FAIL=1; fi
            sz=$(stat -c%s "$p"); if (( sz < 10000 )); then echo "too small ($sz): $p"; FAIL=1; fi
          }
          check extension/dist/assets/*.woff2 || true
          check site/assets/fonts/geist/GeistVariable.woff2 || true
          check site/assets/fonts/satoshi/Satoshi-Variable.woff2 || true
          if (( FAIL > 0 )); then exit 1; fi

      - name: Health check - backend
        continue-on-error: true
        run: |
          # Start backend server in background
          cd backend
          pnpm dev &
          BACKEND_PID=$!
          sleep 10
          
          # Test health endpoint
          echo "Testing backend health endpoint..."
          curl -f http://localhost:3000/api/healthz || echo "Health check failed - backend may not be running"
          
          # Cleanup
          kill $BACKEND_PID || true
          wait $BACKEND_PID || true

      - name: Node invariants (content.js IIFE, no import/export, manifest perms)
        run: |
          set -e
          test -f extension/dist/assets/content.js
          head -c 20 extension/dist/assets/content.js | grep -q "^(function()"
          ! grep -q -E '^\s*(import|export)\s' extension/dist/assets/content.js || (echo "found ESM in content.js" && exit 1)
          node -e 'const fs=require("fs");const p="extension/dist/manifest.json";if(!fs.existsSync(p))throw new Error("manifest missing");const m=JSON.parse(fs.readFileSync(p,"utf8"));if(m.content_scripts)throw new Error("manifest has content_scripts");const ok=JSON.stringify(m.permissions)===JSON.stringify(["activeTab","scripting","storage"]);if(!ok)throw new Error("permissions drift: "+JSON.stringify(m.permissions));if(!(m.background && m.background.service_worker==="service-worker-loader.js"))throw new Error("service_worker misconfigured");console.log("manifest OK");'

      - name: Emit logs and debug info
        if: always()
        run: |
          echo "=== dist listing ==="
          ls -la extension/dist || true
          echo "=== assets listing ==="
          ls -la extension/dist/assets || true
          echo "=== content.js head (200 bytes)==="
          head -c 200 extension/dist/assets/content.js || true
          echo
          echo "=== manifest excerpt ==="
          node -e '
            const fs = require("fs");
            const p = "extension/dist/manifest.json";
            if (fs.existsSync(p)) {
              const m = JSON.parse(fs.readFileSync(p, "utf8"));
              console.log("permissions:", JSON.stringify(m.permissions));
              console.log("content_scripts:", JSON.stringify(m.content_scripts || null));
              console.log("service_worker:", m.background?.service_worker);
            } else {
              console.log("manifest.json missing");
            }
          ' || true

      - name: Upload debug snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-debug-${{ github.run_id }}
          path: |
            extension/dist/**
            ci.log
            *.log
          if-no-files-found: warn
